[
  {
    "row_number": 1,
    "bug_id": " H-02",
    "bug_label": " S2-3",
    "difficulty": 1,
    "bug_description": " \"2 variables not indexed by marketIndex\"",
    "line": "Staker[622]",
    "url": " https://code4rena.com/reports/2021-08-floatcapital#h-02-2-variables-not-indexed-by-marketindex",
    "title": "",
    "main_content": [
      "Submitted by gpersoon",
      "In the token contract:batched_stakerNextTokenShiftIndexis indexed bymarketIndex, so it can have separate (or the same) values for each differentmarketIndex.",
      "stakerTokenShiftIndex_to_longShortMarketPriceSnapshotIndex_mappingandstakerTokenShiftIndex_to_accumulativeFloatIssuanceSnapshotIndex_mappingare not indexed bymarketIndex.\nSo the values ofstakerTokenShiftIndex_to_longShortMarketPriceSnapshotIndex_mappingandstakerTokenShiftIndex_to_accumulativeFloatIssuanceSnapshotIndex_mappingcan be overwritten by a different market, ifbatched_stakerNextTokenShiftIndex[market1]==batched_stakerNextTokenShiftIndex[market2]",
      "This will lead to weird results in_calculateAccumulatedFloat, allocating too much or too little float.",
      "Staker.solL622",
      "Recommend adding an index withmarketIndexto the variables:",
      "stakerTokenShiftIndex_to_longShortMarketPriceSnapshotIndex_mapping",
      "stakerTokenShiftIndex_to_accumulativeFloatIssuanceSnapshotIndex_mapping",
      "Also consider shortening the variable names, this way mistakes can be spotted easier.",
      "Confirmed by Jason of Float Capital: Yes, you are totally right, it should use themarketIndexsince they are specific per market!",
      "JasoonS (Float) confirmed:"
    ],
    "code_blocks": [
      "function\npushUpdatedMarketPricesToUpdateFloatIssuanceCalculations\n(\n...\nstakerTokenShiftIndex_to_longShortMarketPriceSnapshotIndex_mapping\n[\nbatched_stakerNextTokenShiftIndex\n[\nmarketIndex\n]  ] =\nstakerTokenShiftIndex_to_longShortMarketPriceSnapshotIndex_mappingIfShiftExecuted\n;\nstakerTokenShiftIndex_to_accumulativeFloatIssuanceSnapshotIndex_mapping\n[\nbatched_stakerNextTokenShiftIndex\n[\nmarketIndex\n]  ] =\nlatestRewardIndex\n[\nmarketIndex\n] +\n1\n;\nbatched_stakerNextTokenShiftIndex\n[\nmarketIndex\n] +=\n1\n;\n...\n)"
    ],
    "quotes": ["Embarrassed by this one!Thank you for the report.Fixed!!"],
    "proof_of_concept": null,
    "recommended_mitigation": null
  },
  {
    "row_number": 2,
    "bug_id": " H-11",
    "bug_label": " S6-3",
    "difficulty": 1,
    "bug_description": " \"ConstantProductPool.burnSingle swap amount computations should use balance\"",
    "line": "ConstantProductPool[156,175], HybridPool[143,159]",
    "url": " https://code4rena.com/reports/2021-09-sushitrident#h-11-constantproductpoolburnsingle-swap-amount-computations-should-use-balance",
    "title": "",
    "main_content": [
      "Submitted by cmichel",
      "TheConstantProductPool.burnSinglefunction is basically aburnfollowed by aswapand must therefore act the same way as calling these two functions sequentially.",
      "The token amounts to redeem (amount0,amount1) are computed on thebalance(not the reserve).\nHowever, the swap amount is then computed on thereservesand not the balance.\nTheburnfunction would have updated thereserveto the balances and thereforebalanceshould be used here:",
      "For a burn, usually thereserveshould equal thebalance, however if any new tokens are sent to the contract andbalance > reserve, this function will return slightly less swap amounts."
    ],
    "code_blocks": [
      "amount1\n+=\n_getAmountOut\n(\namount0\n,\n_reserve0\n-\namount0\n,\n_reserve1\n-\namount1\n);"
    ],
    "quotes": ["⚠️ The same issue occurs in theHybridPool.burnSingle."],
    "proof_of_concept": null,
    "recommended_mitigation": [
      "Call_getAmountOutwith the balances instead of the reserves:_getAmountOut(amount0, balance0 - amount0, balance1 - amount1)",
      "maxsam4 (Sushi) confirmed:",
      "Please bump this to High sev. This bug can actually lead to loss of funds from the pool. The author found the right issue but failed to analyze the full impact. Regardless, I think they deserve “High” for pointing this out.",
      "alcueca (judge) commented:",
      "This is what we come to C4 for"
    ]
  }
]